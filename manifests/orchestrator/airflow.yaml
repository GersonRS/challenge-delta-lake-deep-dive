apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: airflow
  annotations:
    argocd.argoproj.io/sync-wave: "3"
  namespace: cicd
spec:
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: orchestrator
  project: default
  source:
    repoURL: 'https://airflow.apache.org/'
    targetRevision: 1.8.0
    helm:
      values: |-
        executor: "KubernetesExecutor"
        webserverSecretKeySecretName: my-webserver-secret
        createUserJob:
          useHelmHooks: false
        migrateDatabaseJob:
          useHelmHooks: false
        webserver:
          service: 
            type: LoadBalancer
        data:
          metadataSecretName: airflow-metadata-secret
        postgresql:
          enabled: false
        logs:
          persistence:
            enabled: true
            size: 10Gi
        dags:
          gitSync:
            enabled: true
            repo: "git@github.com:GersonRS/challenge-delta-lake-deep-dive.git"
            branch: main
            rev: HEAD
            depth: 1
            maxFailures: 1
            subPath: "dags"
            sshKeySecret: airflow-ssh-secret
            knownHosts: |-
              |1|yutcXh9HhbK6KCouq3xMQ38B9ns=|V9zQ39gzVxSZ75WU78CGJiVKCOk= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=
              |1|7ww9iNXn8d1jtXlaDjt+fYpsRi0=|vfHsTzw+QATWkCKD7kgG2jhu/1w= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=
        extraSecrets:
          my-airflow-connections:
            data: |
              AIRFLOW_CONN_AWS_DEFAULT: YXdzOi8vLz9yZWdpb25fbmFtZT1ldS13ZXN0LTEmYXdzX2FjY2Vzc19rZXlfaWQ9Z2Vyc29uJmF3c19zZWNyZXRfYWNjZXNzX2tleT1ySGFzTXVVRnpHWTBSRUkySDZSY2RhSkZOWnA5YjlodCZlbmRwb2ludF91cmw9aHR0cCUzQSUyRiUyRm1pbmlvLmRlZXBzdG9yYWdlLnN2Yy5jbHVzdGVyLmxvY2FsJTNBOTAwMA==
          airflow-metadata-secret:
            data: |
              connection: cG9zdGdyZXNxbDovL3NkczhmMjNjNzpmY2EzMTY5MWQyYzhlZThlYzAwZmZkMjVmNGRjN2U0ZUBwb3N0Z3Jlcy1wb3N0Z3Jlc3FsLmRhdGFiYXNlLnN2Yy5jbHVzdGVyLmxvY2FsOjU0MzIvYWlyZmxvdw==
          my-webserver-secret:
            data: |
              webserver-secret-key: NzA3YTNiOTE4MzdhYTNjOTQ0N2U5ZTdmMDUyZTZmNGE=
        
    chart: airflow
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
